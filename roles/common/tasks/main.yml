---
  - name: Add git package repo
    apt_repository: repo=ppa:git-core/ppa state=present

  - name: Update apt cache if needed
    apt: update_cache=yes cache_valid_time=3600 autoremove=yes

  - name: Upgrade OS
    apt: upgrade={{item}} force=yes autoremove=yes
    with_items:
      - dist
      - full

  - name: Install needed packages
    apt: pkg={{item}} state=installed autoremove=yes
    with_items:
      - logrotate
      - curl
      - git
      - update-manager-core

  - name: Remove unwanted services
    apt: name={{item}} state=absent autoremove=yes
    with_items:
      - postfix
      - puppet
      - chef

  - name: Disable periodic OS update checks
    lineinfile: dest=/etc/apt/apt.conf.d/10periodic regexp="^APT::Periodic::Update-Package-Lists \"1\"" line="APT::Periodic::Update-Package-Lists \"0\";" state=present

  - name: Create tmux group
    group: name=tmux state=present

  - name: Create some users
    user: name={{item.name}} comment="tmux user" generate_ssh_key=yes ssh_key_bits=2048 state=present password={{item.password}} shell=/bin/bash groups=tmux
    with_items:
      - { name: 'ita', password: 'ita' }
      - { name: 'peter', password: 'peter' }
      - { name: 'andy', password: 'andy' }
      - { name: 'nicole', password: 'nicole' }
      - { name: 'andrew', password: 'andrew' }
      - { name: 'tiani', password: 'tiani' }

  - name: Copy ssh keys to the user's .ssh directory
    copy: src={{item.key}} dest=/home/{{item.name}}/.ssh/authorized_keys mode=0700 owner={{item.name}} group={{item.name}}
    with_items:
      - { name: 'ita', key: 'ita.pub' }
      - { name: 'peter', key: 'peter.pub' }
      - { name: 'andy', key: 'andy.pub' }
#      - { name: 'nicole', key: 'nicole.pub' }
#      - { name: 'andrew', key: 'andrew.pub' }
#      - { name: 'tiani', key: 'tiani.pub' }

  - name: Set {{user}} as sudoer
    lineinfile: dest=/etc/sudoers line="{{item}} ALL=(ALL) NOPASSWD:ALL"
    with_items:
      - ita
      - peter
      - andy
      - nicole
      - andrew
      - tiani

  - name: Remove ubuntu's user
    user: name=ubuntu state=absent remove=yes

  - name: Set vi preferences
    copy: src=vimrc dest=/home/{{item}}/.vimrc owner={{item}}
    with_items:
      - ita
      - peter
      - andy
      - nicole
      - andrew
      - tiani

  - name: Turn on firwall and allow everything
    ufw: state=enabled policy=allow

  - name: Disallow password authentication
    lineinfile: dest=/etc/ssh/sshd_config
                regexp="^PasswordAuthentication"
                line="PasswordAuthentication no"
                state=present
    notify: Restart ssh

  - name: Disallow root SSH access
    lineinfile: dest=/etc/ssh/sshd_config
                regexp="^PermitRootLogin"
                line="PermitRootLogin no"
                state=present
    notify: Restart ssh
